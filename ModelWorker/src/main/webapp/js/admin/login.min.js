define(['common'],function(common){


    var InterValObj;
    var count = parseInt($("#PHONE_VALID_PERIOD").val(),10) * 60;
    var curCount;
    $(function(){
        $("#forgetPassword").click(function(){
            $("#forgetBox").modal("show");
            //$("#findPassword").reset();
            window.clearInterval(InterValObj);
            $("#sendbtn").removeAttr("disabled");
            $("#sendbtn").html("发送验证码");
            $("#findPassword [name='accountId']").val("");
            $("#findPassword [name='verificationType']").val("1");
            $("#findPassword [name='code']").val("");
            $("#findPassword [name='newpassword']").val("");
            $("#findPassword [name='confirmpassword']").val("");
            count = parseInt($("#PHONE_VALID_PERIOD").val(),10) * 60;
            curCount = 0;
        });
    });

    function sendCode(){
        if ("" ==  $("#findPassword [name='accountId']").val().trim()) {
            MessageBox.info("请输入用户名");
            return;
        }

        if ("2" == $("#findPassword [name='verificationType']").val()) {
            count =  parseInt($("#EMAIL_VALID_PERIOD").val(),10) * 60;
        }

        var type = $("#findPassword [name='verificationType']").val();
        $.ajax({
            url:"${rc.contextPath}/sendcode",
            type:"post",
            dataType:"json",
            data:{
                account: $("#findPassword [name='accountId']").val(),
                type: type
            },
            success:function(data){
                if ("1" ==  data.errType) {
                    MessageBox.info(data.errMsg);
                } else if ("0" ==  data.errType) {
                    curCount = count;
                    $("#sendbtn").attr("disabled", "true");
                    $("#sendbtn").html(curCount + "秒后重发");
                    InterValObj = window.setInterval(SetRemainTime, 1000);

// 					if (type == "1") {
// 						$.ajax({
// 				            url:data.smsUrl,
// 				            type:"post",
// 				            dataType:'JSONP',
// 				            success:function(data){
// 				            	alert(data.success);
// 				            	if (data.success) {
// 				            		curCount = count;
// 			                        $("#sendbtn").attr("disabled", "true");
// 			                        $("#sendbtn").html(curCount + "秒后重发");
// 			                        InterValObj = window.setInterval(SetRemainTime, 1000);
// 				            	} else {
// 				            		MessageBox.info("验证码发送失败");
// 				            	}
// 				            }
// 						})
// 					}

                }
            }
        });
    }
    function SetRemainTime() {
        if (curCount == 0) {
            window.clearInterval(InterValObj);
            $("#sendbtn").removeAttr("disabled");
            $("#sendbtn").html("重新发送验证码");
            $("#code").val("");
        } else {
            curCount--;
            $("#sendbtn").html(curCount + "秒后重发");
        }
    }

    function resetPassword(){
        if ("" ==  $("#findPassword [name='accountId']").val().trim()) {
            MessageBox.info("请输入用户名");
            return;
        }

        if ("" ==  $("#findPassword [name='code']").val().trim()) {
            MessageBox.info("请输入验证码");
            return;
        }

        if(validatePassword()){
            if(checkPassowrdIsMatched()){
                $.ajax({
                    type:"post",
                    url:"${rc.contextPath}/resetPassword",
                    data:{
                        code:$("#code").val(),
                        accountId: $("#findPassword [name='accountId']").val(),
                        password: $("#newpassword").val()
                    },
                    dataType:"json",
                    async:false,
                    success:function(data){
                        if(data.errType == "1"){
                            MessageBox.info(data.errMsg);
                        } else{
                            $("#forgetBox").modal("hide");
                        }
                    }
                });
            }
        }
    }

    function validatePassword() {
        if ($("#newpassword").val().trim().length == 0) {
            MessageBox.info("请输入密码");
            return false;
        } else {
            var flag = checkPasswordIsValidate();
            return flag;
        }
    }

    function checkPasswordIsValidate() {
        var reg = /^(?!\D+$)(?![^a-zA-Z]+$)\S{6,10}$/;
        var pwd = $("#newpassword").val();
        if(!reg.test(pwd)) {
            MessageBox.info("密码至少包含数字、字母，长度6－10");
            return false;
        }
        else{
            return true;
        }
    }

    function checkPassowrdIsMatched() {
        var pwd = $("#newpassword").val();
        var pwd1 = $("#confirmpassword").val();
        if(pwd1.length == 0)
        {
            MessageBox.info("请输入确认密码");
            return false;
        }
        else if (pwd != pwd1) {
            MessageBox.info("两次输入的密码不匹配");
            return false;
        }
        else {
            return true;
        }
    }/**
     * Created by apple on 16/6/19.
     */


    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var role = $(e.target).parent().attr('role')
        $('#loginFlag').val(role);
    })


})